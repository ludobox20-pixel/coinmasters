const SKINS=['skin_0.png','skin_1.png','skin_2.png'];const ASSET_PATH='assets/';let config={type:Phaser.AUTO,parent:'game-container',width:Math.min(800,window.innerWidth),height:Math.min(1200,window.innerHeight),backgroundColor:'#071428',physics:{default:'matter',matter:{gravity:{y:1},enableSleep:true,debug:false}},scene:{preload:preload,create:create,update:update}};let game=new Phaser.Game(config);let state={score:0,coins:0,skinIndex:0};function preload(){this.load.image('bg',ASSET_PATH+'retro_bg.png');this.load.image('coin',ASSET_PATH+'retro_coin.png');this.load.image('button',ASSET_PATH+'retro_button.png');for(let i=0;i<SKINS.length;i++)this.load.image('skin'+i,ASSET_PATH+SKINS[i]);}function create(){const saved=JSON.parse(localStorage.getItem('cp_save')||'{}');state.coins=saved.coins||0;state.score=saved.score||0;state.skinIndex=saved.skinIndex||0;this.add.tileSprite(0,0,config.width,config.height,'bg').setOrigin(0);this.matter.world.setBounds(0,0,config.width,config.height,32,true,true,true,true);let floor=this.add.rectangle(config.width/2,config.height-80,config.width-40,40,0x333344);this.matter.add.gameObject(floor,{isStatic:true});this.pusher=this.add.rectangle(100,config.height-140,200,20,0x66a3ff);this.matter.add.gameObject(this.pusher,{isStatic:true});this.dropY=120;this.collectRect=this.add.rectangle(config.width/2,config.height-60,config.width-160,40,0x000000,0.01);let collectorBody=this.matter.add.gameObject(this.collectRect,{isStatic:true,isSensor:true});this.coinsGroup=this.add.group();this.input.on('pointerdown',(pointer)=>{dropCoinAt(this,pointer.x,this.dropY);});this.matter.world.on('collisionstart',(event)=>{event.pairs.forEach((pair)=>{let a=pair.bodyA.gameObject;let b=pair.bodyB.gameObject;[a,b].forEach(obj=>{if(!obj||!obj.texture)return;});if(a&&b){if(a.texture.key.startsWith('coin')&&pair.bodyB.isSensor)handleCollect(this,a);else if(b.texture.key.startsWith('coin')&&pair.bodyA.isSensor)handleCollect(this,b);}});});document.getElementById('score').innerText='Score: '+state.score;document.getElementById('coins').innerText='Coins: '+state.coins;setupShopUI(this);setInterval(()=>saveState(),3000);}function update(time,delta){let amp=160;let x=config.width/2+Math.sin(time/800)*amp;this.pusher.x=x;this.pusher.body.position.x=this.pusher.x;this.pusher.body.position.y=this.pusher.y;this.pusher.body.angle=0;Phaser.Actions.Call(this.coinsGroup.getChildren(),(coin)=>{if(!coin.body)return;if(Math.abs(coin.y-this.pusher.y)<40&&coin.x<this.pusher.x+100&&coin.x>this.pusher.x-200){this.matter.applyForceFromPosition(coin.body,{x:0.002,y:0},{x:coin.x,y:coin.y});}if(coin.y>config.height+200){coin.destroy();}});if(Math.random()<0.02){document.getElementById('score').innerText='Score: '+state.score;document.getElementById('coins').innerText='Coins: '+state.coins;}}function dropCoinAt(scene,x,y){let key='coin';if(state.skinIndex>=0&&state.skinIndex<SKINS.length){key=scene.textures.exists('skin'+state.skinIndex)?'skin'+state.skinIndex:'coin';}let c=scene.add.image(x,y,key).setScale(0.6);scene.matter.add.gameObject(c,{shape:{type:'circle',radius:32},restitution:0.02,friction:0.2});scene.coinsGroup.add(c);AudioPlayCollect(false);return c;}function handleCollect(scene,coin){if(!coin||coin.collected)return;coin.collected=true;coin.destroy();state.score+=10;state.coins+=1;document.getElementById('score').innerText='Score: '+state.score;document.getElementById('coins').innerText='Coins: '+state.coins;saveState();AudioPlayCollect(true);}function saveState(){localStorage.setItem('cp_save',JSON.stringify(state));}function setupShopUI(scene){const shopBtn=document.getElementById('btn-shop');const closeBtn=document.getElementById('btn-close-shop');const shopPanel=document.getElementById('shop-panel');const shopItems=document.getElementById('shop-items');function openShop(){shopItems.innerHTML='';for(let i=0;i<SKINS.length;i++){let div=document.createElement('div');div.className='shop-item';let img=document.createElement('img');img.src=ASSET_PATH+SKINS[i];div.appendChild(img);let title=document.createElement('div');title.innerText='Skin #'+i;div.appendChild(title);let price=50*(i+1);let btn=document.createElement('button');btn.innerText=(state.skinIndex==i)?'Equipped':((state.coins>=price)?'Buy '+price:'Need '+price);btn.disabled=(state.coins<price)||(state.skinIndex==i);btn.onclick=()=>{if(state.coins>=price){state.coins-=price;state.skinIndex=i;saveState();document.getElementById('coins').innerText='Coins: '+state.coins;shopPanel.style.display='none';AudioPlayClick();}};div.appendChild(btn);shopItems.appendChild(div);}shopPanel.style.display='block';}shopBtn.onclick=openShop;closeBtn.onclick=()=>shopPanel.style.display='none';document.getElementById('btn-reset').onclick=()=>{if(confirm('Reset save?')){state.score=0;state.coins=0;state.skinIndex=0;saveState();document.getElementById('score').innerText='Score: '+state.score;document.getElementById('coins').innerText='Coins: '+state.coins;alert('Reset done');}}}function AudioPlayCollect(real){try{let ctx=window._audio_ctx||(window._audio_ctx=new(window.AudioContext||window.webkitAudioContext)());let o=ctx.createOscillator();let g=ctx.createGain();o.type='sine';o.frequency.value=real?880:660;g.gain.value=0.02;o.connect(g);g.connect(ctx.destination);o.start();setTimeout(()=>{o.stop();},80);}catch(e){}}function AudioPlayClick(){AudioPlayCollect(true);}
